# some boiler plate generated by chat gpt
name: CI Workflow for Snakemake and pytest

on:
  push:
    branches:
      - main  # Trigger the workflow when pushing to the main branch
      - py-tests # when pushing to py-tests branch for dev
  pull_request:
    branches:
      - main  # Trigger on pull requests to main branch

jobs:
  snakemake:
    runs-on: ubuntu-latest  # Set the environment to Ubuntu

    steps:
    # Step 1: Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up Conda
    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v2
      with:
        conda-version: 'latest'  # Use the latest version of Miniconda
        environment-file: environment.yml  # Point to your conda environment file (if exists)

    # Step 3: Create and activate the Conda environment
    - name: Create Conda environment
      run: |
        conda env create -f workflows/envs/environment.yaml # Create the environment from the YAML file
        conda activate pypsa-china  # name is defined in yaml

    # Run tests using pytest
    - name: Run pytest
      run: |
        conda activate myenv  # Ensure the environment is activated
        pytest  # Run pytest (make sure your tests are discovered and run)

    #  cache the Conda environment (for faster CI)
    - name: Cache Conda environment
      uses: actions/cache@v2  
      with:
        path: ~/.conda
        key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}
        restore-keys: |
          ${{ runner.os }}-conda-

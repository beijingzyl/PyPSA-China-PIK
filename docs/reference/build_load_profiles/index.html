<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>build_load_profiles - PyPSA China Model (PIK edition) Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "build_load_profiles";
        var mkdocs_page_input_path = "docs/reference/build_load_profiles.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> PyPSA China Model (PIK edition) Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../tutorials/">Tutorials</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../../reference/">Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../add_brownfield/">add_brownfield</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../add_electricity/">add_electricity</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../add_existing_baseyear/">add_existing_baseyear</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_biomass_potential/">build_biomass_potential</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_cop_profiles/">build_cop_profiles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_cutout/">build_cutout</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">build_load_profiles</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_population/">build_population</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_population_gridcell_map/">build_population_gridcell_map</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_province_shapes/">build_province_shapes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_renewable_potential/">build_renewable_potential</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_solar_thermal_profiles/">build_solar_thermal_profiles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_temperature_profiles/">build_temperature_profiles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../constants/">constants</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fetch_rasters/">fetch_rasters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fetch_shapes/">fetch_shapes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../functions/">functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../make_summary/">make_summary</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plot_heatmap/">plot_heatmap</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plot_network/">plot_network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plot_network_heat/">plot_network_heat</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plot_statistics/">plot_statistics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plot_summary_all/">plot_summary_all</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plot_time_series/">plot_time_series</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../prepare_base_network/">prepare_base_network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../prepare_base_network_2020/">prepare_base_network_2020</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../prepare_network/">prepare_network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../prepare_network_common/">prepare_network_common</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../readers/">readers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../solve_network/">solve_network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../solve_network_myopic/">solve_network_myopic</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">PyPSA China Model (PIK edition) Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Reference</li>
      <li class="breadcrumb-item active">build_load_profiles</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="build_load_profiles"></a>
    <div class="doc doc-contents first">

        <p>Functions for the rules to build the hourly heat and load demand profiles
- electricity load profiles are based on scaling an hourly base year profile to yearly future projections
- daily heating demand is based on the degree day approx (from atlite) &amp; upscaled hourly based
  on an intraday profile (for Denmark by default, see snakefile)</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.build_daily_heat_demand_profiles" class="doc doc-heading">
            <code class="highlight language-python">build_daily_heat_demand_profiles(heat_demand_config, atlite_heating_hr_shift, switch_month_day=True)</code>

</h2>


    <div class="doc doc-contents ">

        <p>build the heat demand profile according to forecast demans</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>heat_demand_config</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>the heat demand configuration</p>
              </div>
            </li>
            <li>
              <b><code>atlite_heating_hr_shift</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>the hour shift for heating demand, needed due to imperfect
timezone handling in atlite</p>
              </div>
            </li>
            <li>
              <b><code>switch_month_day</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>whether to switch month &amp; day from heat_demand_config.
Defaults to True.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    pd.DataFrame: regional daily heating demand with April to Sept forced to 0</p>


            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def build_daily_heat_demand_profiles(
    heat_demand_config: dict, atlite_heating_hr_shift: int, switch_month_day: bool = True
) -&gt; pd.DataFrame:
    """build the heat demand profile according to forecast demans

    Args:
        heat_demand_config (dict): the heat demand configuration
        atlite_heating_hr_shift (int): the hour shift for heating demand, needed due to imperfect
            timezone handling in atlite
        switch_month_day (bool, optional): whether to switch month &amp; day from heat_demand_config.
            Defaults to True.
    Returns:
        pd.DataFrame: regional daily heating demand with April to Sept forced to 0
    """
    with pd.HDFStore(snakemake.input.population_map, mode="r") as store:
        pop_map = store["population_gridcell_map"]

    cutout = atlite.Cutout(snakemake.input.cutout)
    atlite_year = get_cutout_params(snakemake.config)["weather_year"]

    pop_matrix = sp.sparse.csr_matrix(pop_map.T)
    index = pop_map.columns
    index.name = "provinces"

    # TODO clarify a bit here, maybe the po_matrix should be normalised earlier?
    # unclear whether it's per cap or not
    total_hd = cutout.heat_demand(
        matrix=pop_matrix,
        index=index,
        threshold=heat_demand_config["heating_start_temp"],
        a=heat_demand_config["heating_lin_slope"],
        constant=heat_demand_config["heating_offet"],
        # hack to bring it back to local from UTC
        hour_shift=atlite_heating_hr_shift,
    )

    regonal_daily_hd = total_hd.to_pandas().divide(pop_map.sum())
    # input given as dd-mm but loc as yyyy-mm-dd
    if switch_month_day:
        start_day = "{}-{}".format(*heat_demand_config["start_day"].split("-")[::-1])
        end_day = "{}-{}".format(*heat_demand_config["end_day"].split("-")[::-1])
    else:
        start_day = heat_demand_config["start_day"]
        end_day = heat_demand_config["end_day"]
    regonal_daily_hd.loc[f"{atlite_year}-{start_day}":f"{atlite_year}-{end_day}"] = 0

    return regonal_daily_hd</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.build_heat_demand_profile" class="doc doc-heading">
            <code class="highlight language-python">build_heat_demand_profile(daily_hd, hot_water_per_day, snapshots, planning_horizons)</code>

</h2>


    <div class="doc doc-contents ">

        <p>Downscale the daily heat demand to hourly heat demand using pre-defined intraday profiles
THIS FUNCTION ALSO MAKES PROJECTIONS FOR HEATING DEMAND - WHICH IS NOT THE CORRECT PLACE</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>daily_hd</code></b>
                  (<code><span title="DataFrame">DataFrame</span></code>)
              –
              <div class="doc-md-description">
                <p>the day resolved heat demand for each region (atlite time axis)</p>
              </div>
            </li>
            <li>
              <b><code>hot_water_per_day</code></b>
                  (<code><span title="DataFrame">DataFrame</span></code>)
              –
              <div class="doc-md-description">
                <p>the day resolved hot water demand for each region</p>
              </div>
            </li>
            <li>
              <b><code>snapshots</code></b>
                  (<code><span title="pandas.date_range">date_range</span></code>)
              –
              <div class="doc-md-description">
                <p>the snapshots for the planning year</p>
              </div>
            </li>
            <li>
              <b><code>planning_horizons</code></b>
                  (<code><span title="int">int</span> | <span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>the planning year</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="tuple">tuple</span>[<span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.DataFrame">DataFrame</span>, <span title="object">object</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
              –
              <div class="doc-md-description">
                <p>tuple[pd.DataFrame, pd.DataFrame, object, pd.DataFrame]:
heat, space_heat, space_heating_per_hdd, water_heat demands</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def build_heat_demand_profile(
    daily_hd: pd.DataFrame,
    hot_water_per_day: pd.DataFrame,
    snapshots: pd.date_range,
    planning_horizons: int | str,
) -&gt; tuple[pd.DataFrame, pd.DataFrame, object, pd.DataFrame]:
    """Downscale the daily heat demand to hourly heat demand using pre-defined intraday profiles
    THIS FUNCTION ALSO MAKES PROJECTIONS FOR HEATING DEMAND - WHICH IS NOT THE CORRECT PLACE

    Args:
        daily_hd (DataFrame): the day resolved heat demand for each region (atlite time axis)
        hot_water_per_day (DataFrame): the day resolved hot water demand for each region
        snapshots (pd.date_range): the snapshots for the planning year
        planning_horizons (int | str): the planning year

    Returns:
        tuple[pd.DataFrame, pd.DataFrame, object, pd.DataFrame]:
            heat, space_heat, space_heating_per_hdd, water_heat demands
    """
    # TODO - very strange, why would this be needed unless atlite is buggy
    daily_hd_uniq = daily_hd[~daily_hd.index.duplicated(keep="first")]
    # hourly resolution regional demand (but wrong data, it's just ffill)
    heat_demand_hourly = shift_profile_to_planning_year(
        daily_hd_uniq, planning_yr=planning_horizons
    ).reindex(index=snapshots, method="ffill")

    # ===== downscale to hourly =======
    intraday_profiles = pd.read_csv(snakemake.input.intraday_profiles, index_col=0)

    # TODO, does this work with variable frequency?
    intraday_year_profiles = downscale_time_data(
        dt_index=heat_demand_hourly.index,
        weekly_profile=(
            list(intraday_profiles["weekday"]) * 5 + list(intraday_profiles["weekend"]) * 2
        ),
        regional_tzs=pd.Series(index=PROV_NAMES, data=list(REGIONAL_GEO_TIMEZONES.values())),
    )

    # TWh -&gt; MWh
    space_heat_demand_total = pd.read_csv(snakemake.input.space_heat_demand, index_col=0) * 1e6
    space_heat_demand_total = space_heat_demand_total.squeeze()

    # ==== SCALE TO FUTURE DEMAND ======
    # TODO soft-code ref/base year or find a better variable name
    # TODO remind coupling: fix this kind of stuff or make separate fn
    # Belongs outside of this function really and in main
    factor = make_heat_demand_projections(
        planning_horizons, snakemake.wildcards["heating_demand"], ref_year=REF_YEAR
    )
    # WOULD BE NICER TO SUM THAN TO WEIGH OR TO directly build the profile with the freq
    # TODO, does this work with variable frequency?
    space_heating_per_hdd = (space_heat_demand_total * factor) / (
        heat_demand_hourly.sum() * snakemake.config["snapshots"]["frequency"]
    )

    space_heat_demand = intraday_year_profiles.mul(heat_demand_hourly).mul(space_heating_per_hdd)
    water_heat_demand = intraday_year_profiles.mul(hot_water_per_day / 24.0)

    heat_demand = space_heat_demand + water_heat_demand

    return heat_demand, space_heat_demand, space_heating_per_hdd, water_heat_demand</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.build_hot_water_per_day" class="doc doc-heading">
            <code class="highlight language-python">build_hot_water_per_day(planning_horizons)</code>

</h2>


    <div class="doc doc-contents ">

        <p>Make projections for the hot water demand increase and scale the ref year value
NB: the ref year value is for 2008 not 2020 -&gt; incorrect</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>planning_horizons</code></b>
                  (<code><span title="int">int</span> | <span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>the planning year to which demand will be projected</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>if the config projection type is not supported</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pandas.Series">Series</span></code>
              –
              <div class="doc-md-description">
                <p>pd.Series: regional hot water demand per day</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def build_hot_water_per_day(planning_horizons: int | str) -&gt; pd.Series:
    """Make projections for the hot water demand increase and scale the ref year value
    NB: the ref year value is for 2008 not 2020 -&gt; incorrect

    Args:
        planning_horizons (int | str): the planning year to which demand will be projected

    Raises:
        ValueError: if the config projection type is not supported

    Returns:
        pd.Series: regional hot water demand per day
    """

    with pd.HDFStore(snakemake.input.population, mode="r") as store:
        population_count = store["population"]

    unit_hot_water_start_yr = UNIT_HOT_WATER_START_YEAR
    unit_hot_water_end_yr = UNIT_HOT_WATER_END_YEAR

    if snakemake.wildcards["heating_demand"] == "positive":

        def func(x, a, b):
            return a * x + b

        x = np.array([START_YEAR, END_YEAR])
        y = np.array([unit_hot_water_start_yr, unit_hot_water_end_yr])
        popt, pcov = curve_fit(func, x, y)

        unit_hot_water = func(int(planning_horizons), *popt)

    elif snakemake.wildcards["heating_demand"] == "constant":
        unit_hot_water = unit_hot_water_start_yr

    elif snakemake.wildcards["heating_demand"] == "mean":

        def lin_func(x: np.array, a: float, b: float) -&gt; np.array:
            return a * x + b

        x = np.array([START_YEAR, END_YEAR])
        y = np.array([unit_hot_water_start_yr, unit_hot_water_end_yr])
        popt, pcov = curve_fit(lin_func, x, y)
        popt, pcov = curve_fit(lin_func, x, y)

        unit_hot_water = (lin_func(int(planning_horizons), *popt) + UNIT_HOT_WATER_START_YEAR) / 2
    else:
        raise ValueError(f"Invalid heating demand type {snakemake.wildcards['heating_demand']}")
    # MWh per day per region
    hot_water_per_day = unit_hot_water * population_count / 365.0

    return hot_water_per_day</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.downscale_time_data" class="doc doc-heading">
            <code class="highlight language-python">downscale_time_data(dt_index, weekly_profile, regional_tzs)</code>

</h2>


    <div class="doc doc-contents ">

        <p>Make hourly resolved data profiles based on exogenous weekdays and weekend profiles.
This fn takes into account that the profiles are in local time and that regions may
 have different timezones.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>dt_index</code></b>
                  (<code><span title="DatetimeIndex">DatetimeIndex</span></code>)
              –
              <div class="doc-md-description">
                <p>the snapshots (in network local naive time) but hourly res.</p>
              </div>
            </li>
            <li>
              <b><code>weekly_profile</code></b>
                  (<code><span title="collections.abc.Iterable">Iterable</span></code>)
              –
              <div class="doc-md-description">
                <p>the weekly profile as a list of 7*24 entries.</p>
              </div>
            </li>
            <li>
              <b><code>regional_tzs</code></b>
                  (<code><span title="pandas.Series">Series</span></code>)
              –
              <div class="doc-md-description">
                <p>regional geographical timezones for profiles.
Defaults to pd.Series(index=PROV_NAMES, data=list(REGIONAL_GEO_TIMEZONES.values())).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
              –
              <div class="doc-md-description">
                <p>pd.DataFrame: Regionally resolved profiles for each snapshot hour rperesented by dt_index</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def downscale_time_data(
    dt_index: pd.DatetimeIndex,
    weekly_profile: Iterable,
    regional_tzs: pd.Series,
) -&gt; pd.DataFrame:
    """Make hourly resolved data profiles based on exogenous weekdays and weekend profiles.
    This fn takes into account that the profiles are in local time and that regions may
     have different timezones.

    Args:
        dt_index (DatetimeIndex): the snapshots (in network local naive time) but hourly res.
        weekly_profile (Iterable): the weekly profile as a list of 7*24 entries.
        regional_tzs (pd.Series, optional): regional geographical timezones for profiles.
            Defaults to pd.Series(index=PROV_NAMES, data=list(REGIONAL_GEO_TIMEZONES.values())).

    Returns:
        pd.DataFrame: Regionally resolved profiles for each snapshot hour rperesented by dt_index
    """
    weekly_profile = pd.Series(weekly_profile, range(24 * 7))
    # make a dataframe with timestamps localized to the network TIMEZONE timestamps
    all_times = pd.DataFrame(
        dict(zip(PROV_NAMES, [dt_index.tz_localize(TIMEZONE)] * len(PROV_NAMES))),
        index=dt_index.tz_localize(TIMEZONE),
        columns=PROV_NAMES,
    )
    # then localize to regional time. _dt ensures index is not changed
    week_hours = all_times.apply(
        lambda col: col.dt.tz_convert(regional_tzs[col.name]).tz_localize(None)
    )
    # then convert into week hour &amp; map to the intraday heat demand profile (based on local time)
    return week_hours.apply(lambda col: col.dt.weekday * 24 + col.dt.hour).apply(
        lambda col: col.map(weekly_profile)
    )</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.make_heat_demand_projections" class="doc doc-heading">
            <code class="highlight language-python">make_heat_demand_projections(planning_year, projection_name, ref_year=REF_YEAR)</code>

</h2>


    <div class="doc doc-contents ">

        <p>Make projections for heating demand</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>projection_name</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>name of projection</p>
              </div>
            </li>
            <li>
              <b><code>planning_year</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>year to project to</p>
              </div>
            </li>
            <li>
              <b><code>ref_year</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code><span title="constants.REF_YEAR">REF_YEAR</span></code>
)
              –
              <div class="doc-md-description">
                <p>reference year. Defaults to REF_YEAR.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>float</code></b>(                  <code><span title="float">float</span></code>
)              –
              <div class="doc-md-description">
                <p>scaling factor relative to base year for heating demand</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def make_heat_demand_projections(
    planning_year: int, projection_name: str, ref_year=REF_YEAR
) -&gt; float:
    """Make projections for heating demand

    Args:
        projection_name (str): name of projection
        planning_year (int): year to project to
        ref_year (int, optional): reference year. Defaults to REF_YEAR.

    Returns:
        float: scaling factor relative to base year for heating demand
    """
    years = np.array([1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020, 2060])

    if projection_name == "positive":

        def func(x, a, b, c, d):
            """Cubic polynomial fit to proj"""
            return a * x**3 + b * x**2 + c * x + d

        # TODO soft code
        # heated area projection in China
        # 2060: 6.02 * 36.52 * 1e4 north population * floor_space_per_capita in city
        heated_area = np.array(
            [2742, 21263, 64645, 110766, 252056, 435668, 672205, 988209, 2198504]
        )  # 10000 m2

        # Perform curve fitting
        popt, pcov = curve_fit(func, years, heated_area)
        factor = func(int(planning_year), *popt) / func(REF_YEAR, *popt)

    elif projection_name == "constant":
        factor = 1.0

    else:
        raise ValueError(f"Invalid heating demand projection {projection_name}")
    return factor</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.prepare_hourly_load_data" class="doc doc-heading">
            <code class="highlight language-python">prepare_hourly_load_data(hourly_load_p, prov_codes_p)</code>

</h2>


    <div class="doc doc-contents ">

        <p>Read the hourly demand data and prepare it for use in the model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>hourly_load_p</code></b>
                  (<code><span title="os.PathLike">PathLike</span></code>)
              –
              <div class="doc-md-description">
                <p>raw elec data from zenodo, see readme in data.</p>
              </div>
            </li>
            <li>
              <b><code>prov_codes_p</code></b>
                  (<code><span title="os.PathLike">PathLike</span></code>)
              –
              <div class="doc-md-description">
                <p>province mapping for data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
              –
              <div class="doc-md-description">
                <p>pd.DataFrame: the hourly demand data with the right province names, in TWh/hr</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def prepare_hourly_load_data(
    hourly_load_p: os.PathLike,
    prov_codes_p: os.PathLike,
) -&gt; pd.DataFrame:
    """Read the hourly demand data and prepare it for use in the model

    Args:
        hourly_load_p (os.PathLike, optional): raw elec data from zenodo, see readme in data.
        prov_codes_p (os.PathLike, optional): province mapping for data.

    Returns:
        pd.DataFrame: the hourly demand data with the right province names, in TWh/hr
    """
    TO_TWh = 1e-6
    hourly = pd.read_csv(hourly_load_p)
    hourly_TWh = hourly.drop(columns=["Time Series"]) * TO_TWh
    prov_codes = pd.read_csv(prov_codes_p)
    prov_codes.set_index("Code", inplace=True)
    hourly_TWh.columns = hourly_TWh.columns.map(prov_codes["Full name"])
    return hourly_TWh</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.project_elec_demand" class="doc doc-heading">
            <code class="highlight language-python">project_elec_demand(hourly_demand_base_yr_MWh, yearly_projections_TWh, year=2020)</code>

</h2>


    <div class="doc doc-contents ">

        <p>project the hourly demand to the future years</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>hourly_demand_base_yr_MWh</code></b>
                  (<code><span title="pandas.DataFrame">DataFrame</span></code>)
              –
              <div class="doc-md-description">
                <p>the hourly demand in the base year</p>
              </div>
            </li>
            <li>
              <b><code>yearly_projections_TWh</code></b>
                  (<code><span title="pandas.DataFrame">DataFrame</span></code>)
              –
              <div class="doc-md-description">
                <p>the yearly projections</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>pd.DataFrame: the projected hourly demand</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def project_elec_demand(
    hourly_demand_base_yr_MWh: pd.DataFrame, yearly_projections_TWh: pd.DataFrame, year=2020
):
    """project the hourly demand to the future years

    Args:
        hourly_demand_base_yr_MWh (pd.DataFrame): the hourly demand in the base year
        yearly_projections_TWh (pd.DataFrame): the yearly projections

    Returns:
        pd.DataFrame: the projected hourly demand
    """
    hourly_load_TWH_hr = hourly_demand_base_yr_MWh.loc[:, PROV_NAMES]
    # normalise the hourly load
    hourly_load_TWH_hr /= hourly_load_TWH_hr.sum(axis=0)

    yearly_projections_TWh = yearly_projections_TWh.T.loc[int(year), PROV_NAMES]
    hourly_load_projected = yearly_projections_TWh.multiply(hourly_load_TWH_hr)

    if len(hourly_load_projected) == 8784:
        # rm feb 29th
        hourly_load_projected.drop(hourly_load_projected.index[1416:1440], inplace=True)
    elif len(hourly_load_projected) != 8760:
        raise ValueError("The length of the hourly load is not 8760 or 8784 (leap year, dropped)")

    snapshots = make_periodic_snapshots(
        year=year,
        freq="1h",
        start_day_hour="01-01 00:00:00",
        end_day_hour="12-31 23:00",
        bounds="both",
    )

    hourly_load_projected.index = snapshots
    return hourly_load_projected</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="build_load_profiles.read_yearly_projections" class="doc doc-heading">
            <code class="highlight language-python">read_yearly_projections(yearly_projections_p='resources/data/load/Province_Load_2020_2060.csv')</code>

</h2>


    <div class="doc doc-contents ">

        <p>prepare projections for model use</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>yearly_projections_p</code></b>
                  (<code><span title="os.PathLike">PathLike</span></code>, default:
                      <code>&#39;resources/data/load/Province_Load_2020_2060.csv&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>the data path.
    Defaults to "resources/data/load/Province_Load_2020_2060.csv".</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
              –
              <div class="doc-md-description">
                <p>pd.DataFrame: the formatted data</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>workflow/scripts/build_load_profiles.py</code></summary>
              <pre class="highlight"><code class="language-python">def read_yearly_projections(
    yearly_projections_p: os.PathLike = "resources/data/load/Province_Load_2020_2060.csv",
) -&gt; pd.DataFrame:
    """prepare projections for model use

    Args:
        yearly_projections_p (os.PathLike, optional): the data path.
                Defaults to "resources/data/load/Province_Load_2020_2060.csv".

    Returns:
        pd.DataFrame: the formatted data
    """
    TO_TWh = 1 / 10
    yearly_proj_TWh = pd.read_csv(yearly_projections_p)
    yearly_proj_TWh.rename(columns={"Unnamed: 0": "province"}, inplace=True)
    yearly_proj_TWh.set_index("province", inplace=True)
    yearly_proj_TWh.rename(columns={c: int(c) for c in yearly_proj_TWh.columns}, inplace=True)

    return yearly_proj_TWh * TO_TWh</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../build_cutout/" class="btn btn-neutral float-left" title="build_cutout"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../build_population/" class="btn btn-neutral float-right" title="build_population">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../build_cutout/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../build_population/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
